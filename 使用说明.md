# 缺陷快照助手 - 使用说明

<div align="center">
  <img src="./assets/logo/logo.png" alt="缺陷快照助手 Logo" width="120" />
</div>

## 1. 安装

1. 打开 `chrome://extensions/`
2. 开启“开发者模式”
3. 点击“加载已解压的扩展程序”
4. 选择本项目目录

## 2. 首次配置（必须）

进入扩展“选项”页后，先配置：

1. `TAPD 配置`
- 项目 ID 列表：如 `47910877`
- TAPD 域名：如 `tapd.cn`

2. `标注面板下拉值`
- 处理人候选（每行一个）
- 迭代候选（每行一个）

3. （可选）`AI 助手`
- Endpoint / Key / Model / Timeout
- 可先点“测试连接”确认可用

## 3. 日常使用流程

1. 在业务页面按 `Alt+S` 开始截图标注。
2. 框选主区域后，逐条添加问题框与描述。
3. 在“完成提交”前，选择：
- 处理人
- 迭代
4. 点击提交，系统会：
- 生成截图并复制到剪贴板
- 自动跳转 TAPD 新建缺陷页
- 自动填充标题、描述、下拉字段

最后在 TAPD 描述区 `Ctrl/Cmd+V` 粘贴截图即可提交。

## 4. 自动填充规则（最新）

### 4.1 标题与描述

- 使用模板渲染，支持变量。
- AI 开启时会先做文案优化，再渲染模板。
- AI 失败则自动回退到原始标注文本。

### 4.2 处理人、迭代（专用逻辑）

- 先处理“处理人”，再处理“迭代”。
- 输入你在标注页选择的值。
- 联想列表出现后默认点第一个候选。
- 不重试：没值或匹配不到则跳过。

### 4.3 其它下拉（通用逻辑）

- 从“下拉配置”读取规则。
- 可配 native / antd / element / custom。
- 可配 CSS/XPath、展开选择器、选项选择器、候选值。
- 支持 AI 从候选值中挑选。

## 5. 模板变量

常用变量：

- `${issue}` 问题摘要
- `${rectangleList}` 编号问题列表
- `${aiDetail}` AI 生成详细描述（无 AI 时自动降级）
- `${pageURL}` 页面地址
- `${timestamp}` 时间
- `${pathLast1}` URL 最后一段
- `${tag}` 标签
- `${secondMenuName}` 二级菜单名（启用菜单匹配时）

示例标题：

```txt
${issue}（${pathLast1}）
```

示例描述：

```txt
【问题类型】${tag}
【详细说明】
${aiDetail}
【页面地址】${pageURL}
【发现时间】${timestamp}
```

## 6. 常见问题

### Q1：为什么只填了部分字段？

A：系统是“尽力填充”，不会因单字段失败中断整体流程。先检查：
- 该字段是否有有效选择器
- 候选值是否完整
- 是否属于处理人/迭代这种专用字段

### Q2：处理人/迭代为什么不走下拉配置？

A：这两个控件在 TAPD 中通常是联想/树选择，和普通 select 不同，已使用专用流程处理，稳定性更高。

### Q3：AI 接口明明可用，为什么偶发失败？

A：常见原因：模型限流、网关超时、返回非 JSON。建议：
- 提高 timeout
- 更换更稳定模型
- 先用“测试连接”验证

## 7. 调试命令

在 TAPD 新建页控制台执行：

```javascript
window.bstTapdDebug.testPageDetection();
window.bstTapdDebug.checkAndFill();
window.bstTapdDebug.isTapdPage();
```

## 8. 快捷键

默认：`Alt+S`（macOS 为 `Option+S`）

如需修改：
- 打开 `chrome://extensions/shortcuts`
- 找到“缺陷快照助手”并改键
